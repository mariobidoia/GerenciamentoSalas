<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ocupa√ß√£o - Gerenciamento de Ambientes</title>
    <!-- Carrega o TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte 'Inter' -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            /* Melhora a barra de rolagem no dark mode */
            ::-webkit-scrollbar { width: 8px; }
            ::-webkit-scrollbar-track { background: #1f2937; }
            ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
            ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        }
        /* Define a altura da barra de progresso */
        .progress-bar { height: 1.25rem; }
        /* Anima√ß√£o de fade-in para os cart√µes */
        .card-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estilo para input month no dark mode */
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8); /* Inverte a cor do √≠cone */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Cabe√ßalho da P√°gina -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400">Dashboard de Ocupa√ß√£o</h1>
                <p class="text-gray-400">Taxa de utiliza√ß√£o dos ambientes por per√≠odo.</p>
            </div>
            <a href="index.html" class="mt-4 sm:mt-0 bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded text-sm transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                </svg>
                Voltar ao Gerenciador
            </a>
        </header>

        <!-- Controles de Per√≠odo -->
        <div class="mb-6 flex flex-wrap items-center justify-center sm:justify-start gap-3">
            <!-- <button id="btn-30-days" class="bg-cyan-600 text-white font-semibold py-2 px-5 rounded-lg transition-colors order-1 sm:order-1">
                √öltimos 30 Dias
            </button> -->
            <button id="btn-180-days" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg transition-colors order-2 sm:order-2">
                √öltimos 180 Dias
            </button>
            <div class="flex items-center gap-2 order-3 sm:order-3">
                <input type="month" id="month-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 p-2">
                <button id="btn-specific-month" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                    Ver M√™s
                </button>
            </div>
        </div>

        <!-- Conte√∫do do Dashboard (Gerado por JS) -->
        <div id="dashboard-content">
            <!-- Estado de Carregamento Inicial -->
            <div id="loading-state" class="text-center p-12 text-gray-400">
                <svg class="animate-spin h-8 w-8 text-cyan-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Calculando ocupa√ß√£o...
            </div>
            <!-- Erro de API (se houver) -->
            <div id="error-state" class="hidden text-center p-12 bg-gray-800 rounded-lg">
                <p class="text-red-400 font-bold text-lg">Erro ao carregar dados.</p>
                <p class="text-gray-400 mt-2">N√£o foi poss√≠vel buscar os agendamentos. Verifique sua conex√£o ou se voc√™ est√° logado.</p>
            </div>
            <!-- Os dados ser√£o injetados aqui -->
        </div>

    </div>

    <!-- JavaScript da P√°gina -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONFIGURA√á√ÉO ---
            const API_BASE_URL = 'https://gerenciadorambientes.azurewebsites.net/api'; // Atualize se necess√°rio

            // DADOS E ESTADO DA APLICA√á√ÉO 
            const sectors = [ // Copiado de script.js - Idealmente viria da API
                { id: 'salas', name: 'Salas', icon: 'üìö', rooms: [
                    { id: 'sala_01', name: 'Sala 01', posts: 32 }, { id: 'sala_02', name: 'Sala 02', posts: 32 },
                    { id: 'sala_03', name: 'Sala 03', posts: 32 }, { id: 'sala_04', name: 'Sala 04', posts: 32 },
                    { id: 'sala_05', name: 'Sala 05', posts: 32 }, { id: 'sala_06', name: 'Sala 06 - Unid 2', posts: 32 },
                    { id: 'sala_07', name: 'Sala 07 - Unid 2', posts: 16 }, { id: 'sala_08', name: 'Sala 08 - Unid 2', posts: 16 },
                ]},
                { id: 'laboratorios', name: 'Laborat√≥rios', icon: 'üñ•Ô∏è', rooms: [
                    { id: 'lab_info_01', name: 'Inform√°tica 01', posts: 20 },
                    { id: 'lab_info_02', name: 'Inform√°tica 02', posts: 20 },
                    { id: 'lab_hidraulica', name: 'Hidr√°ulica', posts: 16 },
                    { id: 'lab_pneumatica', name: 'Pneum√°tica', posts: 16 },
                    { id: 'carrinho_notebook_01', name: 'Notebooks 01 üíª', posts: 20 },
                    { id: 'carrinho_notebook_02', name: 'Notebooks 02 üíª', posts: 20 },
                ]},
                { id: 'usinagem', name: 'Usinagem', icon: '‚öôÔ∏è', rooms: [
                    { id: 'ajustagem', name: 'Ajustagem', posts: 12 }, { id: 'fresagem', name: 'Fresagem', posts: 16 },
                    { id: 'metrologia', name: 'Metrologia', posts: 15 }, { id: 'tornearia', name: 'Tornearia', posts: 12 },
                    { id: 'soldagem', name: 'Soldagem', posts: 10 }, { id: 'serralheria', name: 'Serralheria', posts: 12 },
                    { id: 'centro_cnc', name: 'Centro CNC üñ•Ô∏è', posts: 16 }, { id: 'torno_cnc', name: 'Torno CNC üñ•Ô∏è', posts: 16 },
                ]},
                { id: 'eletroeletronica', name: 'Eletroeletr√¥nica', icon: '‚ö°Ô∏è', rooms: [
                    { id: 'eletronica_01', name: 'Eletr√¥nica 01 üñ•Ô∏è', posts: 16 },
                    { id: 'eletronica_02', name: 'Eletr√¥nica 02 üñ•Ô∏è', posts: 16 },
                    { id: 'automacao', name: 'Automa√ß√£o', posts: 16 },
                    { id: 'clp', name: 'CLP üñ•Ô∏è', posts: 16 },
                    { id: 'predial_01', name: 'Instala√ß√µes Predial 01', posts: 16 },
                    { id: 'predial_02', name: 'Instala√ß√µes Predial 02', posts: 16 },
                ]},
                { id: 'alimentos', name: 'Plantas Alimentos', icon: 'ü•£', rooms: [
                    { id: 'panificacao', name: 'Panifica√ß√£o', posts: 16 }, { id: 'biscoitos', name: 'Biscoitos', posts: 16 },
                    { id: 'leites', name: 'Leites', posts: 16 }, { id: 'carnes', name: 'Carnes', posts: 16 },
                    { id: 'chocolates', name: 'Chocolates', posts: 16 }, { id: 'lab_didatico', name: 'Lab. Did√°tico', posts: 16 },
                ]},
                { id: 'mecanica', name: 'Mec√¢nica', icon: 'üîß', rooms: [
                    { id: 'mec_suspensao', name: 'Mec√¢nica de Suspens√£o', posts: 16 },
                    { id: 'mec_transmissao', name: 'Mec√¢nica de Transmiss√£o', posts: 16 },
                    { id: 'mec_motor', name: 'Mecanica de Motor', posts: 16 },
                    { id: 'injecao', name: 'Eletronica Inje√ß√£o', posts: 16 },
                ]}
            ];

            let allSchedules = {};
            let allRecurring = [];
            
            // Estado da UI
            let currentPeriodMode = 'last_days'; // 'last_days' or 'specific_month'
            let currentPeriodValue = 30; // 30, 180, or 'YYYY-MM' for specific month

            // REFER√äNCIAS DO DOM
            // const btn30 = document.getElementById('btn-30-days');
            const btn180 = document.getElementById('btn-180-days');
            const monthSelect = document.getElementById('month-select');
            const btnSpecificMonth = document.getElementById('btn-specific-month');
            const dashboardContent = document.getElementById('dashboard-content');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            
            // --- FUN√á√ïES DE UTILIDADE ---
            const formatDate = (date) => date.toISOString().split('T')[0];
            const getToken = () => localStorage.getItem('jwt_token');

            async function apiFetch(endpoint, options = {}) {
                // ... (apiFetch function remains the same) ...
                 const token = getToken();
                if (!token) {
                    // Redirect to login or show error immediately
                    errorState.innerHTML = `
                        <p class="text-red-400 font-bold text-lg">N√£o autenticado.</p>
                        <p class="text-gray-400 mt-2">Voc√™ precisa estar logado para ver o dashboard.</p>
                        <a href="index.html" class="mt-4 inline-block bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded text-sm">Ir para Login</a>
                    `;
                    errorState.style.display = 'block';
                    loadingState.style.display = 'none';
                    throw new Error('Token de autentica√ß√£o n√£o encontrado.');
                }
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers,
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });

                    if (!response.ok) {
                        // Handle specific errors like 401/403 differently if needed
                        const errorText = await response.text();
                        console.error(`API Error ${response.status}: ${errorText}`);
                         throw new Error(`Falha na requisi√ß√£o (${response.status}): ${errorText || 'Erro desconhecido'}`);
                    }
                    
                    if (response.status === 204) { // No Content
                        return null;
                    }

                    const text = await response.text();
                    return text ? JSON.parse(text) : null;
                } catch (networkError) {
                     console.error("Network or Fetch Error:", networkError);
                     throw new Error(`Erro de rede: ${networkError.message}`);
                }
            }


            function getBookingForDate(roomId, date, periodId) {
                // ... (getBookingForDate function remains the same) ...
                 const dateKey = formatDate(date);
                const currentDateOnly = new Date(dateKey + 'T12:00:00Z');
                
                // 1. Verifica agendamentos √∫nicos (schedules)
                const daySchedule = allSchedules[dateKey]?.[roomId]?.[periodId];
                if (daySchedule) {
                    return daySchedule.isBlocked ? { isBlocked: true } : { isOccupied: true };
                }

                // 2. Verifica agendamentos recorrentes (allRecurring)
                const dayOfWeek = currentDateOnly.getUTCDay(); // 0 = Domingo, 1 = Segunda...

                const recurring = allRecurring.find(r => {
                    if (r.roomId !== roomId || r.period !== periodId) return false;

                    // Verifica se as datas no objeto 'r' s√£o v√°lidas antes de usar split
                    if (!r.startDate || !r.endDate) return false; 

                    const startDate = new Date(r.startDate.split('T')[0] + 'T12:00:00Z');
                    const endDate = new Date(r.endDate.split('T')[0] + 'T12:00:00Z');

                    if (currentDateOnly < startDate || currentDateOnly > endDate) return false;

                    if (r.type === 'weekly') {
                         // Verifica se daysOfWeek existe e √© um array antes de usar includes
                        return Array.isArray(r.daysOfWeek) && r.daysOfWeek.includes(dayOfWeek);
                    }
                    if (r.type === 'daily') {
                        if (r.weekdaysOnly) {
                            return dayOfWeek >= 1 && dayOfWeek <= 5; // Seg a Sex
                        }
                        return true;
                    }
                    return false;
                });

                if (recurring) {
                    return { isOccupied: true }; // Recorrentes n√£o s√£o bloqueios
                }
                
                return null;
            }
            
            // --- L√ìGICA DO DASHBOARD ---

            /**
             * Carrega dados da API e renderiza com base no per√≠odo selecionado
             */
            async function loadDataAndRender() {
                // Mostrar loading
                loadingState.style.display = 'block';
                errorState.style.display = 'none';
                dashboardContent.innerHTML = ''; // Limpa conte√∫do antigo (exceto loading/error states que est√£o fora)

                try {
                    // Busca dados da API (apenas se ainda n√£o carregados)
                    // Considerar adicionar l√≥gica para recarregar se os dados estiverem "velhos"
                    if (Object.keys(allSchedules).length === 0 || allRecurring.length === 0) {
                         console.log("Fetching API data...");
                        const [schedules, recurring] = await Promise.all([
                            apiFetch('/Data/schedules'),
                            apiFetch('/Data/recurring-schedules')
                        ]);
                        allSchedules = schedules || {}; // Garante objeto
                        allRecurring = recurring || []; // Garante array
                         console.log("API data fetched.");
                    } else {
                         console.log("Using cached API data.");
                    }


                    // Determina o intervalo de datas com base no modo atual
                    let startDate, endDate;
                    let totalDaysInPeriod;

                    if (currentPeriodMode === 'last_days') {
                        endDate = new Date();
                        startDate = new Date();
                        startDate.setDate(endDate.getDate() - (currentPeriodValue - 1));
                        totalDaysInPeriod = currentPeriodValue;
                    } else { // specific_month
                        if (!currentPeriodValue || !/^\d{4}-\d{2}$/.test(currentPeriodValue)) {
                            throw new Error("M√™s selecionado inv√°lido.");
                        }
                        const [year, month] = currentPeriodValue.split('-').map(Number);
                        // M√™s em JS √© 0-indexado (0 = Janeiro, 11 = Dezembro)
                        startDate = new Date(year, month - 1, 1); 
                        // Para pegar o √∫ltimo dia, v√° para o m√™s seguinte e dia 0
                        endDate = new Date(year, month, 0); 
                        // Calcula o n√∫mero de dias no m√™s
                         totalDaysInPeriod = endDate.getDate(); 
                    }

                    // Renderiza o dashboard para o per√≠odo calculado
                    renderDashboard(startDate, endDate, totalDaysInPeriod);
                    
                    loadingState.style.display = 'none';

                } catch (error) {
                    console.error("Erro ao carregar ou renderizar dashboard:", error);
                    loadingState.style.display = 'none';
                    // Atualiza a mensagem de erro espec√≠fica
                    const errorMsgElement = errorState.querySelector('p:last-child');
                    if (errorMsgElement) {
                        errorMsgElement.textContent = `Detalhes: ${error.message}`;
                    }
                    errorState.style.display = 'block';
                }
            }
            
            /**
             * Renderiza todos os cart√µes do dashboard para um dado per√≠odo
             */
            function renderDashboard(startDate, endDate, totalDaysInPeriod) {
                let html = '';
                
                 console.log(`Rendering dashboard from ${formatDate(startDate)} to ${formatDate(endDate)} (${totalDaysInPeriod} days)`);


                // Itera sobre os setores
                for (const sector of sectors) {
                    html += `
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-cyan-400 border-b-2 border-gray-700 pb-2 mb-4 flex items-center gap-3">
                                <span class="text-3xl">${sector.icon}</span>
                                ${sector.name}
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    `;

                    let cardDelay = 0;
                    for (const room of sector.rooms) {
                        // Calcula estat√≠sticas para o per√≠odo
                        const stats = calculateRoomStats(room.id, startDate, endDate, totalDaysInPeriod);
                        
                        html += `
                            <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 card-fade-in" style="animation-delay: ${cardDelay}ms">
                                <h3 class="font-bold text-lg text-white mb-4 truncate" title="${room.name}">${room.name}</h3>
                                <div class="space-y-4">
                                    ${createProgressBar('Manh√£ ‚òÄÔ∏è', stats.manha, 'bg-yellow-500')}
                                    ${createProgressBar('Tarde üåá', stats.tarde, 'bg-blue-500')}
                                    ${createProgressBar('Noite üåô', stats.noite, 'bg-indigo-500')}
                                </div>
                            </div>
                        `;
                        cardDelay += 50; 
                    }

                    html += `</div></div>`;
                }
                
                // Insere o HTML gerado DENTRO do #dashboard-content
                dashboardContent.innerHTML = html;
            }

            /**
             * Retorna o HTML de uma barra de progresso
             */
            function createProgressBar(label, percentage, colorClass) {
                // ... (createProgressBar function remains the same) ...
                 const perc = Math.max(0, Math.min(100, percentage)).toFixed(0); // Garante 0-100
                return `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-300">${label}</span>
                            <span class="text-sm font-bold text-white">${perc}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full progress-bar overflow-hidden">
                            <div class="${colorClass} h-full rounded-full transition-all duration-500 ease-out" style="width: ${perc}%"></div>
                        </div>
                    </div>
                `;
            }

            /**
             * Calcula a % de ocupa√ß√£o para uma sala dentro de um intervalo de datas
             */
            function calculateRoomStats(roomId, startDate, endDate, totalDaysInPeriod) {
                let occupiedManha = 0;
                let occupiedTarde = 0;
                let occupiedNoite = 0;

                // Garante que totalDaysInPeriod √© pelo menos 1 para evitar divis√£o por zero
                if (totalDaysInPeriod <= 0) {
                     console.warn(`Total days in period is ${totalDaysInPeriod} for ${roomId}. Returning 0% occupation.`);
                     return { manha: 0, tarde: 0, noite: 0 };
                }

                let currentDate = new Date(startDate);

                // Itera por cada dia no per√≠odo
                 while (currentDate <= endDate) {
                    // Cria uma nova data para a verifica√ß√£o para n√£o modificar currentDate diretamente
                    let checkDate = new Date(currentDate); 
                    checkDate.setHours(12, 0, 0, 0); // Normaliza hora para UTC meio-dia

                    if (isTurnOccupied(roomId, checkDate, 'manha')) occupiedManha++;
                    if (isTurnOccupied(roomId, checkDate, 'tarde')) occupiedTarde++;
                    if (isTurnOccupied(roomId, checkDate, 'noite')) occupiedNoite++;
                    
                    // Vai para o pr√≥ximo dia
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                return {
                    manha: (occupiedManha / totalDaysInPeriod) * 100,
                    tarde: (occupiedTarde / totalDaysInPeriod) * 100,
                    noite: (occupiedNoite / totalDaysInPeriod) * 100
                };
            }

            /**
             * Verifica se um TURNO est√° ocupado (qualquer per√≠odo n√£o bloqueado)
             */
            function isTurnOccupied(roomId, date, turn /* 'manha', 'tarde', 'noite' */) {
                // ... (isTurnOccupied function remains the same) ...
                 const p1 = getBookingForDate(roomId, date, `${turn}_antes`);
                const p2 = getBookingForDate(roomId, date, `${turn}_apos`);
                const p3 = getBookingForDate(roomId, date, `${turn}_todo`);

                // Considera ocupado se qualquer per√≠odo do turno estiver ocupado E n√£o for um bloqueio
                const isOccupied = (p1 && p1.isOccupied) || 
                                   (p2 && p2.isOccupied) || 
                                   (p3 && p3.isOccupied);
                                   
                return isOccupied;
            }

            /**
             * Atualiza a apar√™ncia dos bot√µes de per√≠odo
             */
             function updateButtonStyles() {
                 // Reset styles
                 [btn180, btnSpecificMonth].forEach(btn => {
                     btn.classList.remove('bg-cyan-600');
                     btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                 });

                 // Apply active style
                 if (currentPeriodMode === 'last_days') {
                     if (currentPeriodValue === 30) {
                         
                     } else if (currentPeriodValue === 180) {
                         btn180.classList.add('bg-cyan-600');
                         btn180.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                     }
                 } else { // specific_month
                     btnSpecificMonth.classList.add('bg-cyan-600');
                     btnSpecificMonth.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                 }
             }

            
            // --- EVENT LISTENERS ---


            btn180.addEventListener('click', () => {
                 if (currentPeriodMode === 'last_days' && currentPeriodValue === 180) return; 
                currentPeriodMode = 'last_days';
                currentPeriodValue = 180;
                updateButtonStyles();
                loadDataAndRender();
            });

            btnSpecificMonth.addEventListener('click', () => {
                 const selectedMonth = monthSelect.value; // Formato "YYYY-MM"
                 if (!selectedMonth) {
                     alert("Por favor, selecione um m√™s.");
                     return;
                 }
                 // Verifica se j√° est√° nesse modo e m√™s para evitar recarregar
                 if (currentPeriodMode === 'specific_month' && currentPeriodValue === selectedMonth) return; 

                 currentPeriodMode = 'specific_month';
                 currentPeriodValue = selectedMonth;
                 updateButtonStyles();
                 loadDataAndRender();
            });

             // Listener para o input de m√™s (opcional, poderia s√≥ usar o bot√£o "Ver M√™s")
             // monthSelect.addEventListener('change', () => {
             //     // Poderia chamar loadDataAndRender() diretamente aqui, 
             //     // ou apenas habilitar/desabilitar o bot√£o "Ver M√™s".
             //     // Por simplicidade, vamos usar o bot√£o.
             // });


            // --- INICIALIZA√á√ÉO ---
            // Define o valor inicial do input month para o m√™s atual
             const now = new Date();
             const currentMonthISO = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
             monthSelect.value = currentMonthISO;

            // Carrega os dados da API e renderiza o dashboard pela primeira vez (para os √∫ltimos 30 dias)
            loadDataAndRender();
        });
    </script>
</body>
</html>